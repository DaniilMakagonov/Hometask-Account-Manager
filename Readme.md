# Доманее задание

---
## Условие

Провести анализ и разработать набор тестов для классов AccountManager 
и Account согласно приложенной спецификации с использованием
заглушек при взаимодействии с IServer и IpasswordEncoder, соответствующих 
требованиям к их поведению. При этом требуется обеспечить проверки как 
отдельных методов класса Account согласно спецификации и допустимых 
вариантов ответа сервера, так и сценариев работы, описанных в (в виде
отдельных тестов). При обнаружении ошибки требуется ее устранить и
написать тест для ситуации в которой она воспроизводится на исходной версии. 
___
## Сценарии тестирования

1. Сценарий 1. Пользователь (user) проводит попытку авторизации в системе управления аккаунтами с указанием некорректного логина. После этого он проводит вторую попытку авторизации с указанием корректного логина и неправильного пароля. С третьей попытки пользователь авторизуется и делает запрос баланса. После получения значения проводится попытка внести на счет 100 единиц. Полученное значение сравнивается с ожидаемым.
2. Сценарий 2. Пользователь (user) проводит успешную авторизацию. Проводится попытка снятия 50 единиц (неудачная). Делается запрос на количество средств на счету. Проводится внесение 100 единиц. Проводится снятие 50 единиц. Проводится выход из системы (logout).

---
## Спецификация классов

### AccountManager
Класс AccountManager представляет собой класс для инициализации пользовательских сессий в виде экземпляров класса Account. В классе содержится экземпляр IServer, используемый для связи с сервером а также IPasswordEncoder используемый при шифровании пароля. Список используемых логинов и связанных с ними сессий содержится в поле activeAccounts недоступном в публичном интерфейсе.

Инициализация экземпляра класса производится путем вызова метода init с указанием экземпляра класса для соединения с сервером(IServerConnection) и экземпляра класса-шифровальщика (IpasswordEncoder). Метод также автоматически вызывается при создании экземпляра класса AccountManager. При указании null значения любого аргумента при инициализации возникает ошибка NULL_ARGUMENT_EXCEPTION. При попытке повторной инициализации экземпляра происходит ошибка ALREADY_INITIATED_RESPONSE.

Для инициации сессии работы с пользовательским аккаунтом на экземпляре AccountManager требуется вызывать метод login с указанием логина и незашифрованного пароля. При указании null значения любого аргумента происходит ошибка NULL_ARGUMENT_EXCEPTION. После вызова метола создается экземпляр рабочей сессии и производится попытка логина на сервере с указанным логином и зашифрованным через IPasswordEncoder паролем. При возникновении ошибки при шифровании возвращается  ENCODING_ERROR_RESPONSE. При удачной попытке входа на сервер логин отмечается как используемый и данные по сессии вносятся в список. Повторные попытки входа на сервер с указанием уже используемого логина приводят к возникновению ошибки ALREADY_INITIATED_RESPONSE без изменения списка используемых логинов.
При возникновении любых проблем выполнение прерывается, запись об инциденте заносится в список ошибок, возвращается null, данные по рабочей сессии не вносятся в список активных. В ситуации работы без ошибок — возвращается экземпляр сессии для работы с аккаунтом внесенный в список активных.

Для завершения сеанса работы с аккаунтом должен быть вызван метод logout при выполнении которого производится попытка завершения рабочей сессии. При указании null значения аргумента или передачи рабочей сессии со значением null параметра login происходит ошибка NULL_ARGUMENT_EXCEPTION. Если переданная в аргументе рабочая сессия не значится в списке активных — происходит ошибка INCORRECT_SESSION_RESPONSE. При удачном завершении рабочей сессии производится исключение этой сессии из списка используемых и становится доступным повторное использование соответствующего логина.
При возникновении любых проблем выполнение прерывается, запись об инциденте заносится в список ошибок, статус аккаунта не изменяется.

Метод registerException используется для регистрации возникших проблем и сторонним пользователям недоступен.
Метод getExceptions может использоваться для получения возникших при выполнении методов класса инцидентов (исключая процесс инициализации).

Под возникновением определенной ошибки (например, INCORRECT_SESSION_RESPONSE) в ситуациях кроме инициализации подразумевается объявление экземпляра класса OperationFailedException и его сохранение в системе учета ошибок при помощи вызова метода registerException. При возникновении в процессе работы сессии аккаунта ошибки или поведения отличного от корректного выполнения (при работе с ними в методах класса AccountManager) информация об инциденте также должна быть занесена в вызова registerException. Записи о всех произошедших инцидентах могут быть получены путем вызова метода getExceptions. 

### Account

Экземпляр рабочей сессии используемый для взаимодействия с сервером в рамках работы с одним аккаунтом. Содержит экземпляр класса IServerConnection для связи с сервером сохраненный с момента создания рабочей сессии (см. AccountManager.login), строку с логином пользователя и числовой идентификатор активной сессии.

Для доступа к функциям изменения баланса используются методы withdraw и deposit. Получение текущего баланса производится при помощи метода getBalance. При этом для работы с этими методами требуется авторизация на сервере. При вызове методов с отсутствующей авторизацией будет возвращаться NOT_LOGGED.

Для доступа к функциям изменения баланса используются методы withdraw и deposit. Получение текущего баланса производится при помощи метода getBalance. При этом для работы с этими методами требуется авторизация на сервере. При вызове методов с отсутствующей авторизацией будет возвращаться NOT_LOGGED.

Большая часть методов возвращает объекты класса LocalOperationResponse, в которых содержится код успешности завершения запроса и передаваемые данные.

**Описание методов:**

callLogin() — используется при авторизации пользователя на сервере, возвращает номер сессии при успешном завершении (SUCCEED). Пароль передается в зашифрованном виде. Считается что сервер хранит зашифрованную версию пароля и сравнивает переданное значение с ней. Возвращаемые коды: ALREADY_LOGGED, ENCODING_ERROR, NO_USER_INCORRECT_PASSWORD, UNDEFINED_ERROR,  SUCCESS 

callLogout() — метод для окончания рабочей сессии. Возвращаемые коды: NOT_LOGGED, INCORRECT_SESSION, UNDEFINED_ERROR, SUCCESS

withdraw(double amount) — метод для списания средств со счета. При успешном снятии, а также при ответе NO_MONEY также содержит значение текущей суммы на счету. Коды возвращения: NOT_LOGGED, INCORRECT_SESSION, UNDEFINED_ERROR, NO_MONEY, SUCCESS

deposit(double amount) — метод для внесения средств на счет. При успешном завершении также возвращает количество средств на счету. Возможные коды: NOT_LOGGED, INCORRECT_SESSION, UNDEFINED_ERROR, SUCCESS

getBalance() — метод для получения текущего баланса на счету. При успешном завершении возвращает величину баланса в ответе. Коды ответов: NOT_LOGGED, INCORRECT_SESSION, UNDEFINED_ERROR, SUCCESS

При возникновении ошибок при работе методов класса а также при ответах сервера отличных от корректного выполнения методы класса возвращают объекты класса LocalOperationResponse со статусом отличным от LocalOperationResponse.SUCCEED.

### IServerConnection

Интерфейс доступа к серверу. Предоставляет методы для авторизации и запросов, связанных с балансом. При обмене данных используется экземпляры ServerResponse.

Доступны следующие методы:

login(String userName, String mdPass) - авторизация пользователя. При успешном завершении возвращает в ответе номер сессии. Номер сессии генерируется случайным образом. При получении зашифрованного пароля mdPass сравнивает его с хранимым на сервере зашифрованным паролем. Может возвращать следующие коды: ALREADY_LOGGED, NO_USER_INCORRECT_PASSWORD, UNDEFINED_ERROR, SUCCESS

logout(long id) — метод для окончания рабочей сессии. Принимает идентификатор сессии. Может возвращать следующие коды: NOT_LOGGED, UNDEFINED_ERROR, SUCCESS

withdraw(long id, double balance) — метод для снятия средств со счета. При отсутствии соответствующей суммы возвращает NO_MONEY. При успешном завершении, а также при возвращении NO_MONEY также возвращает текущий баланс в данных ответа.  Возвращаемые коды: NOT_LOGGED, UNDEFINED_ERROR, NO_MONEY, SUCCESS.

deposit(long id, double balance) — метод для внесения средств на счет. При успешном завершении возвращает текущий баланс в данных ответа. Возвращаемые коды: NOT_LOGGED, UNDEFINED_ERROR, SUCCESS.

getBalance(long id) — метод для получения количества средств на счету. Сумма возвращается в данных ответа при успешном завершении запроса. Возвращаемые коды: NOT_LOGGED, UNDEFINED_ERROR, SUCCESS.

### ServerResponse

Класс используется для хранения и передачи данных о результатах запроса на сервер и включает код успешного завершения\ошибки и дополнительные данные. 

Среди возможных результатов запросов
- SUCCESS = 0 — успешное завершение запроса
- UNDEFINED_ERROR = 1 — не распознанная ошибка
- ALREADY_LOGGED = 2 — попытка зайти на сервер в то время как с этим логином уже была успешная попытка залогиниться
- NOT_LOGGED = 3 — возвращается при попытке выполнить операцию при отсутствии активной сессии не сервере
- NO_USER_INCORRECT_PASSWORD = 4 — возвращается при попытке начать рабочую сессию с некорректным паролем или при отсутствии пользователя с соответствующим именем
- NO_MONEY = 5 — возвращается при попытке снять деньги при отсутствии соответствующей суммы на счету.

### LocalOperationResponse

Класс используется для хранения и передачи данных о результатах запроса извне в менеджер пользовательских аккаунтов.
Содержит код успешности завершения запроса\ошибки, а также может содержать дополнительные данные.

Возможные коды:
- SUCCEED = 0 — успешное завершение запроса
- ALREADY_LOGGED = 1 — возвращается при попытке залогиниться при уже активной сессии
- NOT_LOGGED = 2 — возвращается при попытке вызова методов в незалогиненном состоянии
- NO_USER_INCORRECT_PASSWORD = 3 — возвращается при отсутствующем логине или некорректном пароле
- INCORRECT_RESPONSE = 4 — возвращается, когда от сервера пришел некорректный ответ
- UNDEFINED_ERROR = 5 — возвращается при возникновении непредусмотренной ошибки
- INCORRECT_SESSION = 6 — возвращается при попытке запроса с указанием некорректного номера сессии
- NO_MONEY = 7 — возвращается при попытке снять средства при отсутствии нужного количества на счету
- ENCODING_ERROR = 8 — возвращается при возникновении ошибки шифрования
- ALREADY_INITIATED = 9 — возвращается при попытке повторной инициализации объекта
- NULL_ARGUMENT = 10 — возвращается при попытке передать null аргумент функции

### IPasswordEncoder

Интерфейс используется для получения шифрованной версии пароля. 

makeSecure(String password) — метод для шифрования переданного открытым образом пароля. При успешном завершении возвращает зашифрованную версию пароля которая удовлетворяет следующим правилам:
- возвращаемое значение не должно соответствовать исходной строке;
- для двух разных переданных паролей должен в большинстве случаев возвращаться разный результат шифрования (PS не стоит воспринимать этот пункт слишком строго, достаточно что для многих случаев он будет выполняться);
- при последовательных запусках на одном и том же аргументе будет возвращаться аналогичное значение.

При неудаче шифрования или передаче null в качестве аргумента выбрасывает исключение OperationFailedException с ошибкой NULL_ARGUMENT.
